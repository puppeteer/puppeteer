name: Deflake Puppeteer test

# Declare default permissions as read only.
permissions: read-all

concurrency:
  group: deflake-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      tests:
        description: Tests to deflake (e.g. '[network.spec] *')
        required: true
        type: string
      suite:
        description: Which suite to run?
        required: true
        type: choice
        options:
          - chrome-headless
          - chrome-headful
          - chrome-headless-shell
          - chrome-bidi
          - firefox-headful
          - firefox-headless
      os:
        description: On which OS to run?
        required: true
        type: choice
        options:
          - ubuntu-latest
          - windows-latest
          - macos-latest
      retries:
        description: Number of retries per test
        required: false
        default: 100
        type: number

jobs:
  chrome-deflake:
    name: Deflake test with pattern ${{ inputs.tests }} on ${{ inputs.os }}
    runs-on: ${{ inputs.os }}
    if: ${{ contains(inputs.suite, 'chrome') }}
    strategy:
      fail-fast: false
    steps:
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup Puppeteer GitHub Action
        uses: ./.github/actions/setup
      - name: Run all tests (MacOS)
        if: ${{ matrix.os == 'macos-latest' }}
        run: npm run test -- --test-suite ${{ matrix.suite }} --save-stats-to /tmp/artifacts/${{ github.event_name }}_INSERTID.json
        env:
          PUPPETEER_DEFLAKE_TESTS: '${{ inputs.tests }}'
          PUPPETEER_DEFLAKE_RETRIES: ${{ inputs.retries }}
      - name: Run all tests (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        run: npm run test -- -- --test-suite ${{ matrix.suite }} --save-stats-to /tmp/artifacts/${{ github.event_name }}_INSERTID.json
        env:
          PUPPETEER_DEFLAKE_TESTS: '${{ inputs.tests }}'
          PUPPETEER_DEFLAKE_RETRIES: ${{ inputs.retries }}
      - name: Run all tests (Linux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: xvfb-run --auto-servernum npm run test -- --test-suite ${{ matrix.suite }} --save-stats-to /tmp/artifacts/${{ github.event_name }}_INSERTID.json
        env:
          PUPPETEER_DEFLAKE_TESTS: '${{ inputs.tests }}'
          PUPPETEER_DEFLAKE_RETRIES: ${{ inputs.retries }}

  firefox-tests:
    name: Deflake test with pattern ${{ inputs.tests }} on ${{ inputs.os }}
    runs-on: ${{ inputs.os }}
    if: ${{ contains(inputs.suite, 'firefox') }}
    strategy:
      fail-fast: false
    steps:
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup Puppeteer GitHub Action
        uses: ./.github/actions/setup
      - name: Run all tests (for non-Linux)
        if: ${{ inputs.os != 'ubuntu-latest' }}
        run: npm run test -- --test-suite ${{ inputs.suite }} --save-stats-to /tmp/artifacts/${{ github.event_name }}_INSERTID.json
        env:
          PUPPETEER_DEFLAKE_TESTS: '${{ inputs.tests }}'
          PUPPETEER_DEFLAKE_RETRIES: ${{ inputs.retries }}
      - name: Run all tests (for Linux)
        if: ${{ inputs.os == 'ubuntu-latest' }}
        run: xvfb-run --auto-servernum npm run test -- --test-suite ${{ inputs.suite }} --save-stats-to /tmp/artifacts/${{ github.event_name }}_INSERTID.json
        env:
          PUPPETEER_DEFLAKE_TESTS: '${{ inputs.tests }}'
          PUPPETEER_DEFLAKE_RETRIES: ${{ inputs.retries }}
